@page "/Facturas"
@page "/Facturas/{FacturaId:int}"
@using facturas.Components.Data
@using FacturaModel = facturas.Components.Data.Facturas
@using ArticuloModel = facturas.Components.Data.Articulos
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion
@rendermode InteractiveServer

<PageTitle>@(estaEditandoFactura ? "Editar Factura" : "Nueva Factura")</PageTitle>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1>@(estaEditandoFactura ? $"✏️ Modificar Factura #{FacturaId}" : "📝 Nueva Factura")</h1>
    <div style="display: flex; gap: 8px;">
        <button @onclick='() => Navegacion.NavigateTo("/ListaFacturas")' class="btn-m3 btn-m3-tonal">
            Ver Historial
        </button>
    </div>
</div>

<div class="card-m3">
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
        <div class="input-group-m3">
            <label>CLIENTE / RAZÓN SOCIAL</label>
            <input @bind="nuevaFactura.Cliente" class="input-m3" placeholder="Nombre del cliente..." />
        </div>

        <div class="input-group-m3">
            <label>FECHA DE EMISIÓN</label>
            <input type="date" @bind="nuevaFactura.Fecha" class="input-m3" />
        </div>
    </div>

    <h3 style="color: var(--md-sys-color-primary); margin-bottom: 16px;">Detalle de Productos</h3>

    <div style="overflow-x: auto; margin-bottom: 24px;">
        <table class="table-m3">
            <thead>
                <tr>
                    <th style="width: 50%">Descripción</th>
                    <th style="width: 15%; text-align: center;">Cant.</th>
                    <th style="width: 15%; text-align: right;">Precio</th>
                    <th style="width: 15%; text-align: right;">Total</th>
                    <th style="width: 5%"></th>
                </tr>
            </thead>
            <tbody>
                @if (articulosTemp.Any())
                {
                    @foreach (var a in articulosTemp)
                    {
                        <tr>
                            <td>@a.Nombre</td>
                            <td style="text-align: center;">@a.Cantidad</td>
                            <td style="text-align: right;">@FormatoMoneda(a.Precio)</td>
                            <td style="text-align: right; font-weight: bold;">@FormatoMoneda(a.Subtotal)</td>
                            <td style="text-align: right;">
                                <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                    <button class="btn-icon text-primary" @onclick='() => PrepararEdicion(a)' title="Editar">✎</button>
                                    <button class="btn-icon text-error" @onclick='() => EliminarArticuloTemp(a)' title="Eliminar">🗑</button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #888;">
                            <span style="font-size: 2em; display: block; margin-bottom: 10px;">🛒</span>
                            La lista está vacía. Agrega productos abajo.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (articulosTemp.Any())
    {
        <div style="display: flex; justify-content: flex-end; align-items: center; padding-top: 16px; border-top: 1px dashed #ccc;">
            <div style="text-align: right;">
                <span style="display: block; font-size: 0.9em; color: #666;">TOTAL A PAGAR</span>
                <span style="font-size: 2em; font-weight: bold; color: var(--md-sys-color-primary);">
                    @FormatoMoneda(articulosTemp.Sum(a => a.Subtotal))
                </span>
            </div>
        </div>
    }
</div>

<div class="card-m3" style="background-color: var(--md-sys-color-primary-container);">
    <h4 style="margin-bottom: 16px; color: var(--md-sys-color-on-primary-container);">
        @((indiceArticuloEditando != -1) ? $"✏️ Editando: {articuloActual.Nombre}" : "➕ Agregar Producto")
    </h4>

    <div style="display: grid; grid-template-columns: 3fr 1fr 1fr auto; gap: 16px; align-items: end;">

        <div class="input-group-m3" style="margin-bottom: 0;">
            <label style="color: var(--md-sys-color-on-primary-container);">DESCRIPCIÓN</label>
            <input class="input-m3" placeholder="Ej. Servicio..." @bind="articuloActual.Nombre" />
        </div>

        <div class="input-group-m3" style="margin-bottom: 0;">
            <label style="color: var(--md-sys-color-on-primary-container);">CANT.</label>
            <input type="number" class="input-m3" style="text-align: center;" @bind="articuloActual.Cantidad" min="1" />
        </div>

        <div class="input-group-m3" style="margin-bottom: 0;">
            <label style="color: var(--md-sys-color-on-primary-container);">PRECIO</label>
            <input type="number" step="0.01" class="input-m3" @bind="articuloActual.Precio" />
        </div>

        <div style="display: flex; gap: 8px;">
            @if (indiceArticuloEditando != -1)
            {
                <button class="btn-m3 btn-m3-tonal" @onclick="CancelarEdicionArticulo" style="background-color: white;">Cancelar</button>
            }
            <button class="btn-m3" @onclick="AgregarOActualizarArticulo">
                @((indiceArticuloEditando != -1) ? "Actualizar" : "Agregar")
            </button>
        </div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div style="background-color: #fce8e6; color: #ba1a1a; padding: 16px; border-radius: 8px; margin-top: 20px; border: 1px solid #ba1a1a;">
        ⚠️ @mensajeError
    </div>
}

<div style="margin-top: 24px; text-align: right;">
    <button class="btn-m3" style="font-size: 1.1em; padding: 12px 40px;" @onclick="GuardarFactura">
        @(estaEditandoFactura ? "💾 GUARDAR CAMBIOS" : "💾 FINALIZAR FACTURA")
    </button>
</div>

@code {
    [Parameter]
    public int FacturaId { get; set; } = 0;

    private FacturaModel nuevaFactura = new() { Fecha = DateTime.Now.Date };
    private ArticuloModel articuloActual = new();
    private List<ArticuloModel> articulosTemp = new();
    private string mensajeError = string.Empty;
    private int indiceArticuloEditando = -1;
    private bool estaEditandoFactura => FacturaId != 0;

    private string FormatoMoneda(decimal monto)
    {
        return monto.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("en-US"));
    }

    protected override async Task OnInitializedAsync()
    {
        if (estaEditandoFactura)
        {
            try
            {
                var facturaParaEditar = await ServicioFacturas.ObtenerFacturaPorId(FacturaId);
                if (facturaParaEditar != null)
                {
                    nuevaFactura.Id = facturaParaEditar.Id;
                    nuevaFactura.Fecha = facturaParaEditar.Fecha;
                    nuevaFactura.Cliente = facturaParaEditar.Cliente;
                    articulosTemp = new List<ArticuloModel>(facturaParaEditar.Articulos);
                }
                else
                {
                    mensajeError = $"Factura no encontrada.";
                    FacturaId = 0;
                }
            }
            catch (Exception ex)
            {
                mensajeError = $"Error: {ex.Message}";
            }
        }
        articuloActual = new ArticuloModel();
    }

    private async Task GuardarFactura()
    {
        if (indiceArticuloEditando != -1) CancelarEdicionArticulo();
        mensajeError = string.Empty;

        if (string.IsNullOrWhiteSpace(nuevaFactura.Cliente))
            mensajeError = "El campo 'Cliente' es obligatorio.";
        else if (articulosTemp.Count == 0)
            mensajeError = "Debe agregar al menos un artículo.";

        if (string.IsNullOrWhiteSpace(mensajeError))
        {
            try
            {
                nuevaFactura.Articulos = articulosTemp;
                if (estaEditandoFactura) await ServicioFacturas.ActualizarFactura(nuevaFactura);
                else await ServicioFacturas.AgregarFactura(nuevaFactura);
                Navegacion.NavigateTo("/ListaFacturas");
            }
            catch (Exception ex) { mensajeError = ex.Message; }
        }
    }

    private void AgregarOActualizarArticulo()
    {
        mensajeError = string.Empty;
        if (string.IsNullOrWhiteSpace(articuloActual.Nombre) || articuloActual.Cantidad <= 0 || articuloActual.Precio <= 0)
        {
            mensajeError = "Datos inválidos (Nombre vacío o valores <= 0).";
            return;
        }

        if (indiceArticuloEditando != -1)
        {
            var item = articulosTemp[indiceArticuloEditando];
            item.Nombre = articuloActual.Nombre;
            item.Cantidad = articuloActual.Cantidad;
            item.Precio = articuloActual.Precio;
            CancelarEdicionArticulo();
        }
        else
        {
            articulosTemp.Add(new ArticuloModel { Nombre = articuloActual.Nombre, Cantidad = articuloActual.Cantidad, Precio = articuloActual.Precio });
            articuloActual = new ArticuloModel();
        }
    }

    private void PrepararEdicion(ArticuloModel articulo)
    {
        indiceArticuloEditando = articulosTemp.IndexOf(articulo);
        articuloActual = new ArticuloModel { Nombre = articulo.Nombre, Cantidad = articulo.Cantidad, Precio = articulo.Precio };
    }

    private void CancelarEdicionArticulo()
    {
        indiceArticuloEditando = -1;
        articuloActual = new ArticuloModel();
    }

    private void EliminarArticuloTemp(ArticuloModel articulo)
    {
        articulosTemp.Remove(articulo);
        if (articuloActual.Nombre == articulo.Nombre) CancelarEdicionArticulo();
    }
}