@page "/Facturas"
@page "/Facturas/{FacturaId:int}" 
@using facturas.Components.Data
@using FacturaModel = facturas.Components.Data.Facturas
@using ArticuloModel = facturas.Components.Data.Articulos
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion
@rendermode InteractiveServer

<style>
    body {
        font-family: 'Times New Roman', serif;
        background-color: #fcfcfc; 
    }

    .seccion-baja {
        border: 1px solid black;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #ffffff;
    }

    .input-grupo {
        margin-bottom: 10px;
    }

    .campo-texto {
        width: 100%;
        padding: 5px;
        border: 1px solid #333;
        font-size: 0.9em;
        box-sizing: border-box;
    }

    .tabla-registro {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

        .tabla-registro th, .tabla-registro td {
            border: 1px solid black;
            padding: 4px;
            text-align: left;
        }

        .tabla-registro th {
            background-color: #dddddd;
            font-weight: normal;
        }

    .fila-articulos {
        display: flex;
        gap: 5px;
        margin-top: 10px;
        align-items: center;
    }

    .btn-simple {
        background-color: #90a4ae;
        color: black;
        border: 1px solid #455a64;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .btn-guardar {
        background-color: #4caf50; 
        color: white;
        border: 1px solid #388e3c;
        font-weight: bold;
    }
    
    .btn-actualizar {
        background-color: #ff9800;
        color: black;
        border: 1px solid #e65100;
        font-weight: bold;
    }
    
    .btn-cancelar {
        background-color: #f44336; 
        color: white;
        border: 1px solid #d32f2f;
    }

    .msg-error {
        color: #aa0000;
        margin-top: 10px;
        border: 1px solid #aa0000;
        background-color: #ffdddd;
        padding: 5px;
        font-size: 0.9em;
    }

    .pie-tabla {
        font-weight: bold;
        text-align: right;
        padding: 5px 0;
        border-top: 2px solid black;
        margin-top: 5px;
        font-size: 1.1em;
    }
</style>


<h1>@((estaEditandoFactura) ? $"Modificando Factura #{FacturaId}" : "Sistema Facturación")</h1>

<div class="seccion-baja">
    <h3>@((estaEditandoFactura) ? "Editar Detalles de Factura" : "Crear Nueva Factura")</h3>

    <div class="input-grupo">
        <label style="display: block; font-weight: bold;">Fecha:</label>
        <input type="date" @bind="nuevaFactura.Fecha" class="campo-texto" />
    </div>

    <div class="input-grupo">
        <label style="display: block; font-weight: bold;">Cliente:</label>
        <input @bind="nuevaFactura.Cliente" placeholder="Nombre de la persona" class="campo-texto" />
    </div>

    <h4 style="margin-top: 20px;">Artículos</h4>

    <table class="tabla-registro">
        <thead>
            <tr>
                <th style="width: 45%;">Descripción</th>
                <th style="width: 10%;">Cant.</th>
                <th style="width: 15%;">Precio Unitario</th>
                <th style="width: 20%;">Subtotal</th>
                <th style="width: 10%;">Acción</th> 
            </tr>
        </thead>
        <tbody>
            @foreach (var a in articulosTemp)
            {
                <tr>
                    <td>@a.Nombre</td>
                    <td>@a.Cantidad</td>
                    <td>@a.Precio.ToString("C2")</td>
                    <td>@a.Subtotal.ToString("C2")</td>
                    <td>
                       
                        <button @onclick='() => PrepararEdicion(a)' class="btn-simple" style="padding: 2px 4px; font-size: 0.8em; margin-right: 5px;">Editar</button>
                        <button @onclick='() => EliminarArticuloTemp(a)' class="btn-simple btn-cancelar" style="padding: 2px 4px; font-size: 0.8em;">Eliminar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (articulosTemp.Count > 0)
    {
        <div class="pie-tabla">
            TOTAL (Borrador): @articulosTemp.Sum(a => a.Subtotal).ToString("C2")
        </div>
    }

   
    <h4 style="margin-top: 20px;">@((indiceArticuloEditando != -1) ? $"Editando: {articuloActual.Nombre}" : "Añadir Nuevo Artículo")</h4>
    <div class="fila-articulos">
     
        <input placeholder="Artículo" @bind="articuloActual.Nombre" class="campo-texto" style="flex-basis: 40%;" />
        <input type="number" min="1" placeholder="Cant." @bind="articuloActual.Cantidad" class="campo-texto" style="flex-basis: 15%;" />
        <input type="number" step="0.01" placeholder="Precio" @bind="articuloActual.Precio" class="campo-texto" style="flex-basis: 20%;" />
        
        <button @onclick="AgregarOActualizarArticulo" 
                class="btn-simple @((indiceArticuloEditando != -1) ? "btn-actualizar" : "")" 
                style="flex-basis: 15%; white-space: nowrap;">
            @((indiceArticuloEditando != -1) ? "Actualizar" : "Agregar")
        </button>

        @if (indiceArticuloEditando != -1)
        {
            <button @onclick="CancelarEdicionArticulo" class="btn-simple btn-cancelar" style="flex-basis: 10%;">Cancelar</button>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(mensajeError))
    {
        <p class="msg-error">! @mensajeError</p>
    }

   
    <button @onclick="GuardarFactura" 
            class="btn-simple @((estaEditandoFactura) ? "btn-actualizar" : "btn-guardar")" 
            style="width: 100%; margin-top: 20px; padding: 10px;">
        @((estaEditandoFactura) ? "ACTUALIZAR FACTURA FINAL" : "GUARDAR FACTURA FINAL")
    </button>
</div>

<hr style="border-top: 1px solid #999; margin: 25px 0;" />

<div style="text-align: center;">
    <button @onclick='() => Navegacion.NavigateTo("/ListaFacturas")' class="btn-simple" style="background-color: #007bff; color: white; padding: 10px 20px;">
        Ver Historial de Facturas Guardadas
    </button>
</div>


@code {
    [Parameter]
    public int FacturaId { get; set; } = 0; 

    private FacturaModel nuevaFactura = new() { Fecha = DateTime.Now.Date };
    
    private ArticuloModel articuloActual = new(); 
    
    private List<ArticuloModel> articulosTemp = new();
    private string mensajeError = string.Empty;
    
    private int indiceArticuloEditando = -1;

    private bool estaEditandoFactura => FacturaId != 0;

    protected override async Task OnInitializedAsync()
    {
        if (estaEditandoFactura)
        {
            try
            {
                var facturaParaEditar = await ServicioFacturas.ObtenerFacturaPorId(FacturaId);
                if (facturaParaEditar != null)
                {      
                    nuevaFactura.Id = facturaParaEditar.Id;
                    nuevaFactura.Fecha = facturaParaEditar.Fecha;
                    nuevaFactura.Cliente = facturaParaEditar.Cliente;
                  
                    articulosTemp = new List<ArticuloModel>(facturaParaEditar.Articulos);
                }
                else
                {
                    mensajeError = $"Factura con ID {FacturaId} no encontrada.";
                    FacturaId = 0;
                }
            }
            catch (Exception ex)
            {
                mensajeError = $"Error al cargar la factura para edición: {ex.Message}";
                FacturaId = 0;
            }
        }

        articuloActual = new ArticuloModel();
    }


    private async Task GuardarFactura()
    {
        if(indiceArticuloEditando != -1)
        {
            CancelarEdicionArticulo();
        }

        mensajeError = string.Empty;
        if (string.IsNullOrWhiteSpace(nuevaFactura.Cliente))
        {
            mensajeError = "El campo 'Cliente' es obligatorio.";
        }
        else if (articulosTemp.Count == 0)
        {
            mensajeError = "Debe agregar al menos un artículo a la factura.";
        }

        if (string.IsNullOrWhiteSpace(mensajeError))
        {
            try
            {
                nuevaFactura.Articulos = articulosTemp;

                if (estaEditandoFactura)
                {
                    await ServicioFacturas.ActualizarFactura(nuevaFactura);
                }
                else
                {
                    await ServicioFacturas.AgregarFactura(nuevaFactura);
                }
                Navegacion.NavigateTo("/ListaFacturas");
            }
            catch (InvalidOperationException ex)
            {
                mensajeError = $"Error de base de datos: {ex.Message}";
            }
            catch (Exception ex)
            {
                mensajeError = $"Ocurrió un error inesperado: {ex.Message}";
            }

            StateHasChanged();
        }
    }

    private void AgregarOActualizarArticulo()
    {
        mensajeError = string.Empty;
        if (string.IsNullOrWhiteSpace(articuloActual.Nombre) || articuloActual.Cantidad <= 0 || articuloActual.Precio <= 0)
        {
            mensajeError = "Debe especificar un nombre, cantidad (>0) y precio (>0) para el artículo.";
        }
        else
        {
            if (indiceArticuloEditando != -1)
            {
                var articuloOriginal = articulosTemp[indiceArticuloEditando];
                articuloOriginal.Nombre = articuloActual.Nombre;
                articuloOriginal.Cantidad = articuloActual.Cantidad;
                articuloOriginal.Precio = articuloActual.Precio;
                
                CancelarEdicionArticulo(); 
            }
            else
            {
                articulosTemp.Add(new ArticuloModel
                {
                    Nombre = articuloActual.Nombre,
                    Cantidad = articuloActual.Cantidad,
                    Precio = articuloActual.Precio
                });
                articuloActual = new ArticuloModel(); 
            }
            StateHasChanged();
        }
    }

    private void PrepararEdicion(ArticuloModel articulo)
    { 
        indiceArticuloEditando = articulosTemp.IndexOf(articulo);
        articuloActual = new ArticuloModel 
        { 
            Nombre = articulo.Nombre, 
            Cantidad = articulo.Cantidad, 
            Precio = articulo.Precio 
        };
        mensajeError = string.Empty;
    }

    private void CancelarEdicionArticulo()
    {
        indiceArticuloEditando = -1;
        articuloActual = new ArticuloModel();
        mensajeError = string.Empty;
    }
    
    private void EliminarArticuloTemp(ArticuloModel articulo)
    {
        articulosTemp.Remove(articulo);
        if (articuloActual.Nombre == articulo.Nombre)
        {
            CancelarEdicionArticulo();
        }
        StateHasChanged();
    }
}