@page "/ListaFacturas"
@using facturas.Components.Data
@using FacturaModel = facturas.Components.Data.Facturas
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Historial de Facturas</PageTitle>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1>Historial</h1>
    <div style="display: flex; gap: 8px;">
        <button @onclick='() => Navegacion.NavigateTo("/Facturas")' class="btn-m3">
            + Nueva Factura
        </button>
        <button @onclick='() => Navegacion.NavigateTo("/ReporteSat")' class="btn-m3 btn-m3-tonal">
            Ver Reportes
        </button>
    </div>
</div>

<div class="card-m3">
    <div class="input-group-m3">
        <label>FILTRAR POR CLIENTE</label>
        <input type="text" @bind="filtroCliente" @oninput="FiltrarFacturas" class="input-m3" placeholder="Buscar..." />
    </div>

    @if (facturasFiltradas == null)
    {
        <p>Cargando...</p>
    }
    else if (facturasFiltradas.Count == 0)
    {
        <p style="padding: 20px; text-align: center; color: #888;">No se encontraron facturas activas.</p>
    }
    else
    {
        <table class="table-m3">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th style="text-align: right;">Total</th>
                    <th style="text-align: right;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var f in facturasFiltradas)
                {
                    <tr>
                        <td style="color: #888;">#@f.Id</td>

                        <td>@f.Cliente</td>
                        <td>@f.Fecha.ToShortDateString()</td>
                        <td style="text-align: right; font-weight: bold;">@FormatoMoneda(f.Total)</td>

                        <td style="text-align: right;">
                            <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                <button class="btn-icon" style="color: #2196F3;"
                                        @onclick='() => Navegacion.NavigateTo($"/DetalleFactura/{f.Id}")'
                                        title="Ver Detalles">
                                    👁
                                </button>

                                <button class="btn-icon" style="color: #666;" @onclick="() => ArchivarFactura(f)" title="Archivar">📦</button>

                                <button class="btn-icon text-primary" @onclick='() => Navegacion.NavigateTo($"/Facturas/{f.Id}")' title="Editar">✎</button>
                                <button class="btn-icon text-error" @onclick="() => EliminarFactura(f)" title="Eliminar">🗑</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<FacturaModel> facturas;
    private List<FacturaModel> facturasFiltradas;
    private string filtroCliente = string.Empty;

    private string FormatoMoneda(decimal monto)
    {
        return monto.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("en-US"));
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            facturas = await ServicioFacturas.ObtenerFacturas();
            AplicarFiltro();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            facturas = new List<FacturaModel>();
            facturasFiltradas = new List<FacturaModel>();
        }
    }

    private void FiltrarFacturas(ChangeEventArgs e)
    {
        filtroCliente = e.Value?.ToString() ?? string.Empty;
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (string.IsNullOrWhiteSpace(filtroCliente)) facturasFiltradas = facturas;
        else facturasFiltradas = facturas.Where(f => f.Cliente.Contains(filtroCliente, StringComparison.OrdinalIgnoreCase)).ToList();
        StateHasChanged();
    }

    private async Task ArchivarFactura(FacturaModel f)
    {
        await ServicioFacturas.CambiarEstadoArchivo(f.Id, true);
        await CargarDatos();
    }

    private async Task EliminarFactura(FacturaModel f)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm", $"¿Eliminar permanentemente la factura #{f.Id}?");
        if (confirmado)
        {
            await ServicioFacturas.EliminarFactura(f);
            await CargarDatos();
        }
    }
}