@page "/DetalleFactura/{FacturaId:int}"
@using facturas.Components.Data
@using FacturaModel = facturas.Components.Data.Facturas
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion
@rendermode InteractiveServer

<PageTitle>Detalle de Factura #@FacturaId</PageTitle>

<div style="margin-bottom: 24px;">
    <button @onclick='() => Navegacion.NavigateTo("/ListaFacturas")' style="background:none; border:none; cursor:pointer; color: #666; font-size: 0.9em;">
        ← Volver al historial
    </button>
</div>

@if (factura == null)
{
    <p>Cargando...</p>
}
else
{
    <div class="card-m3">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
            <div>
                <h2 style="margin: 0; color: var(--md-sys-color-primary);">Factura #@FacturaId</h2>
                <p style="margin: 4px 0 0 0; color: #666;">Fecha: @factura.Fecha.ToShortDateString()</p>
            </div>
            <div style="text-align: right;">
                <span style="display: block; font-size: 0.8em; color: #888; text-transform: uppercase;">Cliente</span>
                <span style="font-size: 1.2em; font-weight: 500;">@factura.Cliente</span>
            </div>
        </div>

        <h4 style="margin-bottom: 16px;">Conceptos</h4>

        <table class="table-m3">
            <thead>
                <tr>
                    <th style="width: 60%;">Artículo</th>
                    <th style="width: 10%; text-align: center;">Cantidad</th>
                    <th style="width: 15%; text-align: right;">Precio</th>
                    <th style="width: 15%; text-align: right;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var a in factura.Articulos)
                {
                    <tr>
                        <td>@a.Nombre</td>
                        <td style="text-align: center;">@a.Cantidad</td>
                        <td style="text-align: right;">@FormatoMoneda(a.Precio)</td>
                        <td style="text-align: right;">@FormatoMoneda(a.Subtotal)</td>
                    </tr>
                }
            </tbody>
        </table>

        <div style="margin-top: 30px; text-align: right;">
            <span style="font-size: 1.1em; color: #666; margin-right: 16px;">TOTAL FACTURA:</span>
            <span style="font-size: 2em; font-weight: bold; color: var(--md-sys-color-primary);">@FormatoMoneda(factura.Total)</span>
        </div>

        <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: flex-end;">
            <button @onclick='() => Navegacion.NavigateTo($"/Facturas/{factura.Id}")' class="btn-m3">
                Editar Factura
            </button>
        </div>
    </div>
}

@code {
    [Parameter] public int FacturaId { get; set; }
    private FacturaModel factura;

    private string FormatoMoneda(decimal monto)
    {
        return monto.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("en-US"));
    }

    protected override async Task OnInitializedAsync()
    {
        try { factura = await ServicioFacturas.ObtenerFacturaPorId(FacturaId); }
        catch { factura = null; }
    }
}
