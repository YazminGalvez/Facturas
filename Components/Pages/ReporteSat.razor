@page "/ReporteSat"
@using facturas.Components.Data
@using facturas.Components.Data.Reportes
@using ReporteAnualModel = facturas.Components.Data.Reportes.ReporteAnual
@using ReporteMensualModel = facturas.Components.Data.Reportes.ReporteMensual
@using System.Globalization
@using System.Linq
@rendermode InteractiveServer
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion

<PageTitle>Reporte Anual</PageTitle>

<h1>Reporte Anual</h1>

<div class="card-m3">
    <div style="display: flex; gap: 16px; align-items: flex-end;">
        <div class="input-group-m3" style="margin-bottom: 0;">
            <label>SELECCIONAR AÑO</label>
            <input type="number" min="2000" max="@DateTime.Now.Year" @bind="anioSeleccionado" class="input-m3" style="width: 150px;" />
        </div>
        <button @onclick="GenerarReporte" class="btn-m3">
            Generar Reporte
        </button>
    </div>
</div>

@if (cargando)
{
    <p>Cargando...</p>
}
else if (reporte != null)
{
    <div class="card-m3" style="background-color: var(--md-sys-color-primary); color: white; border: none;">
        <span style="opacity: 0.8; font-size: 0.9em;">INGRESO TOTAL ANUAL (@anioSeleccionado)</span>
        <div style="font-size: 2.5em; font-weight: bold;">@FormatoMoneda(reporte.TotalAnual)</div>
    </div>

    @if (!reporte.Meses.Any(m => m.Facturas.Any()))
    {
        <div class="card-m3" style="text-align: center; color: #888;">No se encontraron datos para este año.</div>
    }
    else
    {
        @foreach (var mes in reporte.Meses.Where(m => m.Facturas.Any()))
        {
            <div class="card-m3">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--md-sys-color-primary);">@mes.NombreMes</h3>
                    <span style="font-weight: bold; color: #444;">@mes.Facturas.Count facturas</span>
                </div>

                <table class="table-m3">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var factura in mes.Facturas)
                        {
                            <tr>
                                <td><a href="/DetalleFactura/@factura.Id">#@factura.Id</a></td>
                                <td>@factura.Cliente</td>
                                <td>@factura.Fecha.ToShortDateString()</td>
                                <td style="text-align: right;">@FormatoMoneda(factura.Total)</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 16px; font-weight: bold;">
                    Total @mes.NombreMes: <span style="color: var(--md-sys-color-primary);">@FormatoMoneda(mes.TotalFacturado)</span>
                </div>
            </div>
        }
    }
}

@code {
    private int anioSeleccionado = DateTime.Now.Year;
    private ReporteAnualModel reporte;
    private bool cargando = false;

    private string FormatoMoneda(decimal monto)
    {
        return monto.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("en-US"));
    }

    private string ObtenerNombreMes(int mes)
    {
        var culture = new CultureInfo("es-ES");
        var nombre = culture.DateTimeFormat.GetMonthName(mes);
        return nombre.Substring(0, 1).ToUpper() + nombre.Substring(1);
    }

    private async Task GenerarReporte()
    {
        cargando = true;
        reporte = null;
        StateHasChanged();

        try
        {
            var facturasDelAnio = await ServicioFacturas.ObtenerFacturasAnuales(anioSeleccionado);
            reporte = new ReporteAnualModel { Anio = anioSeleccionado };
            reporte.Meses = Enumerable.Range(1, 12).Select(m =>
            {
                var mesReporte = new ReporteMensualModel(m, ObtenerNombreMes(m));
                mesReporte.Facturas.AddRange(facturasDelAnio.Where(f => f.Fecha.Month == m));
                return mesReporte;
            }).ToList();
        }
        catch { reporte = null; }

        cargando = false;
        StateHasChanged();
    }
}
