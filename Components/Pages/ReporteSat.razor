@page "/ReporteSat"
@using facturas.Components.Data
@using facturas.Components.Data.Reportes
@using ReporteAnualModel = facturas.Components.Data.Reportes.ReporteAnual
@using ReporteMensualModel = facturas.Components.Data.Reportes.ReporteMensual
@using System.Globalization
@using System.Linq
@rendermode InteractiveServer
@inject ServicioFacturas ServicioFacturas
@inject NavigationManager Navegacion

<style>
    .seccion-baja {
        border: 1px solid black;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #f7f7f7;
    }

    .campo-texto {
        padding: 5px;
        border: 1px solid #333;
    }

    .btn-simple {
        background-color: #90a4ae;
        color: black;
        border: 1px solid #455a64;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .tabla-registro {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

        .tabla-registro th, .tabla-registro td {
            border: 1px solid black;
            padding: 4px;
            text-align: left;
            font-size: 0.9em;
        }

        .tabla-registro th {
            background-color: #dddddd;
            font-weight: normal;
        }

    .pie-tabla {
        font-weight: bold;
        text-align: right;
        padding: 5px 0;
        border-top: 2px solid black;
        margin-top: 5px;
        font-size: 1.1em;
    }

    .btn-reporte {
        background-color: #4CAF50;
        color: white;
        border-color: #388E3C;
    }

    .enlace-detalle {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
    }

    .msg-error {
        color: #aa0000;
        margin-top: 10px;
        border: 1px solid #aa0000;
        background-color: #ffdddd;
        padding: 5px;
        font-size: 0.9em;
    }
</style>

<h1>Reporte Anual de Ingresos</h1>

<div class="seccion-baja" style="display: flex; gap: 10px; align-items: center; background-color: #ffffff;">
    <label>Seleccionar Año:</label>

    <input type="number" min="2000" max="@DateTime.Now.Year" @bind="anioSeleccionado" class="campo-texto" style="width: 120px;" />

    <button @onclick="GenerarReporte" class="btn-simple btn-reporte">
        Generar Reporte
    </button>
</div>

@if (cargando)
{
    <p>Cargando información para el año @anioSeleccionado...</p>
}
else if (reporte == null)
{
    <p>Seleccione un año y haga clic en 'Generar Reporte'.</p>
}
else
{
    <div class="seccion-baja" style="background-color: #f7f7f7; padding: 25px;">
        <h2 style="margin-top: 0;">Total Anual: @FormatoMoneda(reporte.TotalAnual)</h2>

        @if (!reporte.Meses.Any(m => m.Facturas.Any()))
        {
            <p class="msg-error" style="background-color: #fff3cd; color: #856404; border-color: #ffeeba; padding: 10px; border-radius: 4px; margin-top: 15px;">
                ! No se encontraron facturas registradas para el año @reporte.Anio.
            </p>
        }
        else
        {
            @foreach (var mes in reporte.Meses.Where(m => m.Facturas.Any()))
            {
                <div style="margin-top: 25px; border: 1px solid #ccc; padding: 10px; background-color: #ffffff;">
                    <div style="border-bottom: 2px solid #333; margin-bottom: 10px; padding-bottom: 5px;">
                        <h4 style="margin: 0;">Mes: @mes.NombreMes</h4>
                        <p style="margin: 5px 0 0 0;">Facturas Registradas: <strong>@mes.Facturas.Count</strong></p>
                    </div>

                    <table class="tabla-registro" style="font-size: 0.8em;">
                        <thead>
                            <tr style="background-color: #cccccc;">
                                <th style="width: 20%;">ID Factura</th>
                                <th style="width: 35%;">Cliente</th>
                                <th style="width: 25%; text-align: right;">Fecha</th>
                                <th style="width: 20%; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var factura in mes.Facturas)
                            {
                                <tr>
                                    <td>
                                        <a @onclick='() => Navegacion.NavigateTo($"/DetalleFactura/{factura.Id}")' class="enlace-detalle">
                                            #@factura.Id
                                        </a>
                                    </td>
                                    <td>@factura.Cliente</td>
                                    <td style="text-align: right;">@factura.Fecha.ToShortDateString()</td>
                                    <td style="text-align: right;">@FormatoMoneda(factura.Total)</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="pie-tabla" style="font-size: 1.0em; margin-top: 10px; border-top: 1px dashed #666;">
                        TOTAL @mes.NombreMes: <span>@FormatoMoneda(mes.TotalFacturado)</span>
                    </div>
                </div>
            }
        }
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button @onclick='() => Navegacion.NavigateTo("/ListaFacturas")' class="btn-simple" style="background-color: #007bff; color: white; padding: 10px 20px;">
            Volver al Historial
        </button>
    </div>
}

@code {
    private int anioSeleccionado = DateTime.Now.Year;
    private ReporteAnualModel reporte; 
    private bool cargando = false;

    private string FormatoMoneda(decimal monto)
    {
        return monto.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("en-US"));
    }

    private string ObtenerNombreMes(int mes)
    {
        var culture = new CultureInfo("es-ES");
        var nombre = culture.DateTimeFormat.GetMonthName(mes);
        return nombre.Substring(0, 1).ToUpper() + nombre.Substring(1);
    }

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    private async Task GenerarReporte()
    {
        cargando = true;
        reporte = null;
        StateHasChanged();

        try
        {
            var facturasDelAnio = await ServicioFacturas.ObtenerFacturasAnuales(anioSeleccionado);

            reporte = new ReporteAnualModel { Anio = anioSeleccionado };

            reporte.Meses = Enumerable.Range(1, 12)
                .Select(m =>
                {
                    var mesReporte = new ReporteMensualModel(m, ObtenerNombreMes(m));
                    mesReporte.Facturas.AddRange(facturasDelAnio.Where(f => f.Fecha.Month == m));
                    return mesReporte;
                })
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al generar el reporte: {ex.Message}");
            reporte = null;
        }

        cargando = false;
        StateHasChanged();
    }
}